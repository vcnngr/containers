#!/usr/bin/env groovy
/**
 * VCNNGR Apache Pipeline
 * Build Apache HTTP Server container with quality checks
 */

pipeline {
    agent {
        kubernetes {
            namespace 'jenkins'
            yaml '''
apiVersion: v1
kind: Pod
metadata:
  labels:
    jenkins: agent
    container: apache
spec:
  serviceAccountName: jenkins
  containers:
  - name: kaniko
    image: gcr.io/kaniko-project/executor:debug
    command: ["/busybox/cat"]
    tty: true
    volumeMounts:
    - name: docker-config
      mountPath: /kaniko/.docker
    - name: workspace
      mountPath: /workspace
  - name: crane
    image: gcr.io/go-containerregistry/crane:debug
    command: ["/busybox/cat"]
    tty: true
    volumeMounts:
    - name: workspace
      mountPath: /workspace
  - name: shellcheck
    image: koalaman/shellcheck-alpine:latest
    command: [cat]
    tty: true
  - name: sonar-scanner
    image: sonarsource/sonar-scanner-cli:latest
    command: [cat]
    tty: true
  - name: trivy
    image: aquasec/trivy:latest
    command: [cat]
    tty: true
    volumeMounts:
    - name: workspace
      mountPath: /workspace
  volumes:
  - name: docker-config
    emptyDir: {}
  - name: workspace
    emptyDir: {}
'''
        }
    }
    
    parameters {
        string(name: 'APACHE_VERSION', defaultValue: '2.4.65', description: 'Apache version')
        string(name: 'IMAGE_REVISION', defaultValue: '0', description: 'Image revision')
        choice(name: 'DEBIAN_VARIANT', choices: ['debian-12', 'debian-11'], description: 'Debian variant')
        choice(name: 'BUILD_ARCH', choices: ['amd64', 'arm64'], description: 'Architecture')
        booleanParam(name: 'PUSH_TO_DOCKERHUB', defaultValue: false, description: 'Push to DockerHub')
        booleanParam(name: 'RUN_SECURITY_SCAN', defaultValue: true, description: 'Run security scan')
        booleanParam(name: 'RUN_CODE_QUALITY', defaultValue: true, description: 'Run code quality')
        booleanParam(name: 'TAG_AS_LATEST', defaultValue: false, description: 'Tag as latest')
    }
    
    environment {
        CONTAINER_NAME = 'apache'
        MAJOR_VERSION = sh(script: "echo '${params.APACHE_VERSION}' | cut -d. -f1-2", returnStdout: true).trim()
        DOCKERHUB_REGISTRY = 'docker.io'
        DOCKERHUB_NAMESPACE = 'vcnngr'
        IMAGE_BASE = "${DOCKERHUB_REGISTRY}/${DOCKERHUB_NAMESPACE}/${CONTAINER_NAME}"
        TAG_FULL = "${params.APACHE_VERSION}-${params.IMAGE_REVISION}"
        TAG_VERSION = "${params.APACHE_VERSION}"
        DOCKERHUB_CREDS = credentials('dockerhub-credentials')
        BUILD_CONTEXT = "${WORKSPACE}/${CONTAINER_NAME}/${MAJOR_VERSION}/${params.DEBIAN_VARIANT}"
        BUILD_DATE = sh(script: "date -u +'%Y-%m-%dT%H:%M:%SZ'", returnStdout: true).trim()
        GIT_COMMIT_SHORT = sh(script: 'git rev-parse --short HEAD', returnStdout: true).trim()
    }
    
    options {
        buildDiscarder(logRotator(numToKeepStr: '10'))
        timeout(time: 2, unit: 'HOURS')
        timestamps()
        ansiColor('xterm')
    }
    
    stages {
        stage('Validate') {
            steps {
                script {
                    echo """
╔═══════════════════════════════════════════════════════════════╗
║              VCNNGR APACHE BUILD                              ║
╚═══════════════════════════════════════════════════════════════╝

Container:     ${CONTAINER_NAME}
Version:       ${params.APACHE_VERSION}
Revision:      ${params.IMAGE_REVISION}
Architecture:  ${params.BUILD_ARCH}
Build Date:    ${BUILD_DATE}
Git Commit:    ${GIT_COMMIT_SHORT}

Tags:
- ${IMAGE_BASE}:${TAG_FULL}
- ${IMAGE_BASE}:${TAG_VERSION}
- ${IMAGE_BASE}:${MAJOR_VERSION}
${params.TAG_AS_LATEST ? "• ${IMAGE_BASE}:latest" : ""}
═══════════════════════════════════════════════════════════════
"""
                    sh """
                        if [ ! -f "${BUILD_CONTEXT}/Dockerfile" ]; then
                            echo "ERROR: Dockerfile not found at ${BUILD_CONTEXT}/Dockerfile"
                            exit 1
                        fi
                        echo "✓ Dockerfile found"
                        
                        if [ -d "${BUILD_CONTEXT}/prebuildfs" ]; then
                            echo "✓ prebuildfs directory exists"
                        fi
                        
                        if [ -d "${BUILD_CONTEXT}/rootfs" ]; then
                            echo "✓ rootfs directory exists"
                        fi
                    """
                }
            }
        }
        
        stage('Code Quality') {
            when {
                expression { params.RUN_CODE_QUALITY }
            }
            parallel {
                stage('Shellcheck') {
                    steps {
                        container('shellcheck') {
                            script {
                                try {
                                    sh """
                                        cd ${BUILD_CONTEXT}
                                        SCRIPTS=\$(find . -type f -name '*.sh' 2>/dev/null || true)
                                        if [ -n "\$SCRIPTS" ]; then
                                            echo "\$SCRIPTS" | xargs shellcheck -f gcc --severity=warning || echo "Shellcheck warnings found"
                                        else
                                            echo "No shell scripts found"
                                        fi
                                    """
                                } catch (Exception e) {
                                    echo "Shellcheck failed: ${e.message}"
                                }
                            }
                        }
                    }
                }
                
                stage('SonarQube') {
                    steps {
                        container('sonar-scanner') {
                            script {
                                try {
                                    withCredentials([string(credentialsId: 'sonarqube-token', variable: 'SONAR_TOKEN')]) {
                                        sh """
                                            cd ${BUILD_CONTEXT}
                                            sonar-scanner \
                                                -Dsonar.host.url=http://sonarqube-sonarqube.jenkins.svc.cluster.local:9000 \
                                                -Dsonar.token=\${SONAR_TOKEN} \
                                                -Dsonar.projectKey=vcnngr-${CONTAINER_NAME} \
                                                -Dsonar.projectName='VCNNGR ${CONTAINER_NAME}' \
                                                -Dsonar.projectVersion=${params.APACHE_VERSION} \
                                                -Dsonar.sources=. \
                                                -Dsonar.exclusions='**/*.md'
                                        """
                                    }
                                } catch (Exception e) {
                                    echo "SonarQube failed: ${e.message}"
                                }
                            }
                        }
                    }
                }
            }
        }
        
        stage('Build Image') {
            steps {
                container('kaniko') {
                    sh """
                        cd ${BUILD_CONTEXT}
                        
                        # Crea il file secret nella directory corrente
                        echo "downloads.bitnami.com/files/stacksmith" > ./downloads_url_secret
                        
                        # Build con Kaniko con cache
                        /kaniko/executor \
                            --context=\$(pwd) \
                            --dockerfile=Dockerfile \
                            --destination=${IMAGE_BASE}:${TAG_FULL} \
                            --cache=true \
                            --cache-repo=${IMAGE_BASE}-cache \
                            --cache-ttl=24h \
                            --build-arg TARGETARCH=${params.BUILD_ARCH} \
                            --build-arg DOWNLOADS_URL=downloads.bitnami.com/files/stacksmith \
                            --label org.opencontainers.image.created=${BUILD_DATE} \
                            --label org.opencontainers.image.version=${params.APACHE_VERSION} \
                            --label org.opencontainers.image.vendor=Vcnngr \
                            --no-push \
                            --tar-path=/workspace/image.tar
                        
                        # Rimuovi il file secret
                        rm -f ./downloads_url_secret
                        
                        echo "✓ Image built successfully"
                    """
                }
            }
        }
        
        stage('Load and Tag Image') {
            steps {
                container('crane') {
                    sh """
                        # Carica l'immagine dal tar
                        cd /workspace
                        
                        # Tag delle immagini
                        crane tag ${IMAGE_BASE}:${TAG_FULL} ${TAG_VERSION}
                        crane tag ${IMAGE_BASE}:${TAG_FULL} ${MAJOR_VERSION}
                        ${params.TAG_AS_LATEST ? "crane tag ${IMAGE_BASE}:${TAG_FULL} latest" : ""}
                        
                        echo "✓ Image tagged successfully"
                    """
                }
            }
        }
        
        stage('Test Image') {
            steps {
                container('crane') {
                    sh """
                        echo "Testing image metadata..."
                        
                        # Inspect con crane
                        crane config ${IMAGE_BASE}:${TAG_FULL} > /tmp/config.json
                        
                        USER_ID=\$(cat /tmp/config.json | grep -o '"User":"[^"]*"' | cut -d'"' -f4 || echo "")
                        
                        if [ "\$USER_ID" = "1001" ] || [ -z "\$USER_ID" ]; then
                            echo "✓ Image configuration valid"
                        else
                            echo "WARNING: Unexpected user ID: \$USER_ID"
                        fi
                        
                        echo "✓ All tests passed"
                    """
                }
            }
        }
        
        stage('Security Scan') {
            when {
                expression { params.RUN_SECURITY_SCAN }
            }
            steps {
                container('trivy') {
                    script {
                        def maxRetries = 3
                        for (int attempt = 1; attempt <= maxRetries; attempt++) {
                            try {
                                if (attempt > 1) {
                                    sh "trivy clean --all || true"
                                    sleep(5)
                                }
                                
                                sh """
                                    # Scan del tar file
                                    trivy image \
                                        --input /workspace/image.tar \
                                        --severity HIGH,CRITICAL \
                                        --exit-code 0 \
                                        --timeout 10m
                                    
                                    trivy image \
                                        --input /workspace/image.tar \
                                        --format json \
                                        --output /workspace/trivy-report.json || true
                                    
                                    # Copia il report nel workspace Jenkins
                                    cp /workspace/trivy-report.json ${WORKSPACE}/ || true
                                """
                                break
                            } catch (Exception e) {
                                if (attempt == maxRetries) {
                                    echo "Security scan failed after ${maxRetries} attempts"
                                }
                            }
                        }
                    }
                }
            }
        }
        
        stage('Push to DockerHub') {
            when {
                expression { params.PUSH_TO_DOCKERHUB }
            }
            steps {
                container('crane') {
                    sh """
                        # Login to DockerHub
                        echo "\${DOCKERHUB_CREDS_PSW}" | crane auth login \
                            ${DOCKERHUB_REGISTRY} \
                            --username "\${DOCKERHUB_CREDS_USR}" \
                            --password-stdin
                        
                        # Push dell'immagine dal tar
                        crane push /workspace/image.tar ${IMAGE_BASE}:${TAG_FULL}
                        crane tag ${IMAGE_BASE}:${TAG_FULL} ${TAG_VERSION}
                        crane tag ${IMAGE_BASE}:${TAG_FULL} ${MAJOR_VERSION}
                        
                        ${params.TAG_AS_LATEST ? "crane tag ${IMAGE_BASE}:${TAG_FULL} latest" : ""}
                        
                        echo "✓ Images pushed successfully"
                    """
                }
            }
        }
        
        stage('Generate Report') {
            steps {
                script {
                    def metadata = [
                        container: CONTAINER_NAME,
                        version: params.APACHE_VERSION,
                        tags: [
                            "${IMAGE_BASE}:${TAG_FULL}",
                            "${IMAGE_BASE}:${TAG_VERSION}",
                            "${IMAGE_BASE}:${MAJOR_VERSION}"
                        ]
                    ]
                    
                    if (params.TAG_AS_LATEST) {
                        metadata.tags.add("${IMAGE_BASE}:latest")
                    }
                    
                    writeJSON file: 'build-metadata.json', json: metadata, pretty: 4
                    
                    echo """
╔═══════════════════════════════════════════════════════════════╗
║                    BUILD COMPLETE                             ║
╚═══════════════════════════════════════════════════════════════╝

Container: ${CONTAINER_NAME} ${params.APACHE_VERSION}

Images:
"""
                    metadata.tags.each { tag -> echo "  • ${tag}" }
                    
                    echo """
Quick test:
  docker pull ${IMAGE_BASE}:${TAG_VERSION}
  docker run -d -p 8080:8080 ${IMAGE_BASE}:${TAG_VERSION}
  curl http://localhost:8080
═══════════════════════════════════════════════════════════════
"""
                }
            }
        }
    }
    
    post {
        always {
            script {
                try {
                    archiveArtifacts artifacts: '*.json', allowEmptyArchive: true
                } catch (Exception e) {
                    echo "No artifacts to archive"
                }
                
                try {
                    container('crane') {
                        sh "rm -f /workspace/image.tar || true"
                    }
                } catch (Exception e) {
                    echo "Cleanup skipped"
                }
            }
        }
        
        success {
            echo "✓ BUILD SUCCESSFUL"
        }
        
        failure {
            echo "✗ BUILD FAILED - Check console output"
        }
    }
}
